/**
 * Copyright (C) 2012 Heiko Irrgang <hi@93i.de>
 * 
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
gamvas={_layerSort:null,_canvas:null,_context2D:null,_world:null,_usePhys:false,_doSleep:true,_isFullScreen:false,_hasMultiTouch:(typeof document.createTouch!="undefined"),_hasOrientation:(typeof window.DeviceOrientationEvent!="undefined"),baseURL:"",start:function(c,a,d){if((gamvas.isSet(a))&&(a)){gamvas._usePhys=a;var b=d;if(!gamvas.isSet(d)){b=true}gamvas._doSleep=b;gamvas.physics.resetWorld(0,9.8,b)}gamvas._canvas=document.getElementById(c);if(!gamvas.isSet(gamvas._canvas)){console.log("canvas #"+c+" not found, aboring gamvas");return}gamvas._canvas.oncontextmenu=function(){return false};gamvas._context2D=gamvas._canvas.getContext("2d");if(gamvas.config.reverseLayerOrder){gamvas._layerSort=function(g,e){return(e.layer-g.layer)}}else{gamvas._layerSort=function(g,e){return(g.layer-e.layer)}}window.requestAnimationFrame=(function(e){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(g){window.setTimeout(g,1000/60)}})();gamvas.state.setup();gamvas.event.onReady();window.requestAnimationFrame(gamvas.screen.redraw)},getCanvasPosition:function(){return gamvas.dom.getPosition(gamvas._canvas)},getCanvasDimension:function(){return{w:gamvas._canvas.width,h:gamvas._canvas.height}},getCanvas:function(){return gamvas._canvas},getContext2D:function(){return gamvas._context2D},isSet:function(a){if((typeof a=="undefined")||(a===null)){return false}return true},hasMultiTouch:function(){return gamvas._hasMultiTouch},hasOrientation:function(){return gamvas._hasOrientation},hasFullScreen:function(){var a=gamvas.getCanvas();if(a){if(a.requestFullscreen){return true}else{if(a.mozRequestFullScreen){return true}else{if(a.webkitRequestFullscreen){}}}}return false},isFullScreen:function(){return gamvas._isFullScreen},setFullScreen:function(a){gamvas._isFullScreen=false;var b=gamvas.getCanvas();if(b){if(b.requestFullscreen){gamvas._isFullScreen=a;if(a){b.requestFullscreen()}else{b.cancelFullscreen()}}else{if(b.mozRequestFullScreen){gamvas._isFullScreen=a;if(a){b.mozRequestFullScreen()}else{b.mozCancelFullScreen()}}}}}};var tmpScr=document.getElementsByTagName("script");gamvas.baseURL=tmpScr[tmpScr.length-1].src.replace(/\\/g,"/").replace(/\/[^\/]*$/,"");document.addEventListener("fullscreenchange",function(a){var b=gamvas.getCanvas();if(b){if(document.fullScreen){gamvas._isFullScreen=true;console.log(screen.width+"x"+screen.height);b.style.width=screen.width+"px";b.style.height=screen.height+"px"}else{gamvas._isFullScreen=false;b.style.width=b.width+"px";b.style.height=b.height+"px"}}},false);document.addEventListener("mozfullscreenchange",function(a){var b=gamvas.getCanvas();if(b){if(document.mozFullScreen){gamvas._isFullScreen=true}else{gamvas._isFullScreen=false}}},false);(function(){var a=1;var b=false;gamvas.Class=function(){};gamvas.Class.prototype.objectID=function(){if(typeof this.__oid=="undefined"){this.__oid=a++}return this.__oid};gamvas.Class.extend=function(g){var d=this.prototype;b=true;var e=new this();b=false;for(var c in g){if((typeof d[c]=="function")&&(typeof g[c]=="function")){e[c]=(function(h,i){return function(){var k=this._super;this._super=d[h];var j=i.apply(this,arguments);this._super=k;return j}})(c,g[c])}else{e[c]=g[c]}}ret=function(){if((!b)&&(typeof this.create=="function")){this.create.apply(this,arguments)}};ret.prototype=e;ret.prototype.constructor=gamvas.Class;ret.extend=this.extend;return ret}})();gamvas.config={preventKeyEvents:false,preventMouseEvents:false,worldPerState:true,reverseLayerOrder:false};gamvas.Resource=function(){this._finished=true;this.cache=false;this._images=[];this._sounds=[];this.ret=0;this._toLoad=0;this._loaded=0};gamvas.Resource.prototype.getImage=function(b){this._finished=false;this._toLoad++;var a=new Image();a.src=b;this._images.push(a);return a};gamvas.Resource.prototype.getSound=function(b){this._finished=false;this._toLoad++;var a=new Audio();a.src=b;a.loop=false;this._sounds.push(a);return a};gamvas.Resource.prototype._calculate=function(){if(this.cache){return this._loaded}var a=false;var d=[];for(var c=0;c<this._images.length;c++){if(this._images[c].complete){this._loaded++}else{d.push(this._images[c]);a=true}}delete this._images;this._images=d;var b=[];for(var c=0;c<this._sounds.length;c++){switch(this._sounds[c].readyState){case HTMLMediaElement.HAVE_CURRENT_DATA:case HTMLMediaElement.HAVE_FUTURE_DATA:case HTMLMediaElement.HAVE_ENOUGH_DATA:this._loaded++;break;default:b.push(this._sounds[c]);a=true;break}}delete this._sounds;this._sounds=b;if(a==false){this._finished=true}this.cache=true};gamvas.Resource.prototype.status=function(){if(this._finished){return 1}if(this._toLoad===0){return 1}this._calculate();return this._loaded/this._toLoad};gamvas.Resource.prototype.done=function(){if(this._finished){return true}this._calculate();return this._finished};gamvas.math={degToRad:function(a){return a*(Math.PI/180)},radToDeg:function(a){return a*(180/Math.PI)}};gamvas.Rect=function(a,d,b,c){this.x=(a)?a:0;this.y=(d)?d:0;this.width=(b)?b:0;this.height=(c)?c:0};gamvas.Vector2D=function(a,b){(a)?this.x=a:this.x=0;(b)?this.y=b:this.y=0};gamvas.Vector2D.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};gamvas.Vector2D.prototype.quickLength=function(){return this.x*this.x+this.y*this.y};gamvas.Vector2D.prototype.normalized=function(){var b=new gamvas.Vector2D();var a=this.length();b.x=this.x/a;b.y=this.y/a;return b};gamvas.Vector2D.prototype.rotate=function(d){var a=new gamvas.Vector2D();var b=Math.sin(d);var e=Math.cos(d);a.x=e*this.x-b*this.y;a.y=b*this.x+e*this.y;return a};gamvas.Vector2D.prototype.subtract=function(a){var b=new gamvas.Vector2D(this.x,this.y);b.x-=a.x;b.y-=a.y;return b};gamvas.Vector2D.prototype.add=function(a){var b=new gamvas.Vector2D(this.x,this.y);b.x+=a.x;b.y+=a.y;return b};gamvas.Vector2D.prototype.difference=function(a){return new gamvas.Vector2D(a.x-this.x,a.y-this.y)};gamvas.Vector2D.prototype.copy=function(){return new gamvas.Vector2D(this.x,this.y)};gamvas.Vector2D.prototype.distance=function(a){var b=this.difference(a);return b.length()};gamvas.Vector2D.prototype.quickDistance=function(a){var b=this.difference(a);return b.quickLength()};gamvas.dom={getPosition:function(a){var b=[0,0];gamvas.dom.getPositionRec(a,b);return new gamvas.Vector2D(b[0],b[1])},getPositionRec:function(a,b){b[0]+=a.offsetLeft;b[1]+=a.offsetTop;if(a.offsetParent){gamvas.dom.getPosition(a.offsetParent,b)}}};gamvas.event={_onLoadFunctions:[],_onLoadRan:false,_onReadyFunctions:[],_onReadyRan:false,addOnLoad:function(a){if(!gamvas.event._onLoadRan){gamvas.event._onLoadFunctions.push(a)}else{a()}},addOnReady:function(a){if(!gamvas.event._onReadyRan){gamvas.event._onReadyFunctions.push(a)}else{a()}},onLoad:function(){gamvas.event._onLoadRan=true;for(var a in gamvas.event._onLoadFunctions){gamvas.event._onLoadFunctions[a]()}},onReady:function(){gamvas.event._onReadyRan=true;for(var a in gamvas.event._onReadyFunctions){gamvas.event._onReadyFunctions[a]()}},stopBubble:function(b){var a=(typeof b=="undefined")?window.event:b;if(a.stopPropagation){a.stopPropagation()}if(a.preventDefault){a.preventDefault()}if(a.cancelBubble!==null){a.cancelBubble=true}if(a.returnValue){a.returnValue=false}}};window.onload=gamvas.event.onLoad;gamvas.timer={_date:new Date(),_ts:1,getSeconds:function(){return gamvas.timer.getMilliseconds()/1000},getMilliseconds:function(){var a=new Date();return(a.getTime()-gamvas.timer._date.getTime())*gamvas.timer._ts},setGlobalTimeScale:function(a){gamvas.timer._ts=a},getGlobalTimeScale:function(){return gamvas.timer._ts}};gamvas.Sound=function(a){this._file=a};gamvas.Sound.prototype.play=function(){if(this.isReady()){this._file.currentTime=0;this._file.play()}};gamvas.Sound.prototype.loop=function(){if(this.isReady()){this._file.currentTime=0;this._file.loop=true;this._file.play()}};gamvas.Sound.prototype.stop=function(){if(this.isReady()){this._file.pause()}};gamvas.Sound.prototype.resume=function(){if(this.isReady()){this._file.play()}};gamvas.Sound.prototype.setRate=function(a){this._file.playbackRate=a};gamvas.Sound.prototype.setVolume=function(a){this._file.volume=a};gamvas.Sound.prototype.mute=function(){this._file.muted=true};gamvas.Sound.prototype.unmute=function(){this._file.muted=false};gamvas.Sound.prototype.isReady=function(){switch(this._file.readyState){case HTMLMediaElement.HAVE_CURRENT_DATA:case HTMLMediaElement.HAVE_FUTURE_DATA:case HTMLMediaElement.HAVE_ENOUGH_DATA:return true;break;default:return false}};gamvas.key={BACKSPACE:8,TAB:9,RETURN:13,SHIFT:16,CTRL:17,ALT:18,PAUSE:19,BREAK:19,CAPSLOCK:20,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,INSERT:45,DELETE:46,NUM_0:48,NUM_1:49,NUM_2:50,NUM_3:51,NUM_4:52,NUM_5:53,NUM_6:54,NUM_7:55,NUM_8:56,NUM_9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,WIN_LEFT:91,WIN_RIGHT:92,SELECT:93,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,NUMPAD_MULTIPLY:106,NUMPAD_ADD:107,NUMPAD_SUBTRACT:109,NUMPAD_DECIMALPOINT:110,NUMPAD_DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,NUMLOCK:144,SCROLLLOCK:145,SEMICOLON:186,EQUAL:187,COMMA:188,DASH:189,PERIOD:190,SLASH:191,BRACKET_OPEN:219,BACKSLASH:220,BRACKET_CLOSE:221,SINGLE_QUOTE:222,_pressedMap:[],isPressed:function(a){if(!gamvas.isSet(gamvas.key._pressedMap[a])){return false}return gamvas.key._pressedMap[a]},setPressed:function(b,a){gamvas.key._pressedMap[b]=a},exitEvent:function(){if(gamvas.config.preventKeyEvents){return false}return true}};gamvas.mouse={LEFT:0,MIDDLE:1,RIGHT:2,_pressedMap:[],_mouseX:0,_mouseY:0,isPressed:function(a){if(!gamvas.isSet(gamvas.key._pressedMap[a])){return false}return gamvas.key._pressedMap[a]},setPosition:function(a,b){gamvas.mouse._mouseX=a;gamvas.mouse._mouseY=b},getX:function(a){if(a){gamvas.mouse.setPosition(a.pageX,a.pageY)}var b=gamvas.getCanvasPosition();return gamvas.mouse._mouseX-b.x},getY:function(a){if(a){gamvas.mouse.setPosition(a.pageX,a.pageY)}var b=gamvas.getCanvasPosition();return gamvas.mouse._mouseY-b.y},getPosition:function(a){if(a){gamvas.mouse.setPosition(a.pageX,a.pageY)}var b=gamvas.getCanvasPosition();return new gamvas.Vector2D(gamvas.mouse._mouseX-b.x,gamvas.mouse._mouseY-b.y)},setPressed:function(b,a){gamvas.key._pressedMap[b]=a},exitEvent:function(){if(gamvas.config.preventMouseEvents){return false}return true}};gamvas.State=gamvas.Class.extend({create:function(a){this._isInitialized=false;this._pixelPerMeter=64;this._removeQueue=[];this.disableCamera=false;this.name=a;this.autoClear=true;this.clearColor="#000000";this.actors=[];this.eventActors=[];this._afiles=[];this._doSleep=true;this._world=null;this.resource=null;this.canvas=null;this.c=null;this.dimension=null;this.camera=null},_setup:function(){this.resource=new gamvas.Resource();this.canvas=gamvas.getCanvas();this.c=gamvas.getContext2D();this.dimension=gamvas.getCanvasDimension();this.camera=new gamvas.Camera()},init:function(){},enter:function(){},leave:function(){},clearScreen:function(){this.c.fillStyle=this.clearColor;this.c.fillRect(0,0,this.dimension.w,this.dimension.h)},preDraw:function(a){},draw:function(a){},postDraw:function(a){},loading:function(b){var g=gamvas.getCanvasDimension();var e=(g.h/2)-5;var a=parseInt(g.w*0.7,10);var c=parseInt((g.w-a)/2,10);this.c.lineWidth=2;this.c.fillStyle="#ffffff";this.c.strokeStyle="#ffffff";this.c.strokeRect(c+2,e,a,10);this.c.fillRect(c+4,e+2,(a-2)*this.resource.status(),6)},onKeyDown:function(c,b,a){return gamvas.key.exitEvent()},onKeyUp:function(c,b,a){return gamvas.key.exitEvent()},onMouseDown:function(b,a,d,c){return gamvas.mouse.exitEvent()},onMouseUp:function(b,a,d,c){return gamvas.mouse.exitEvent()},onMouseMove:function(a,c,b){return gamvas.mouse.exitEvent()},onTouchDown:function(d,a,c,b){return gamvas.mouse.exitEvent()},onTouchUp:function(d,a,c,b){return gamvas.mouse.exitEvent()},onTouchMove:function(d,a,c,b){return gamvas.mouse.exitEvent()},onOrientation:function(c,b,a){return false},addActor:function(a){this.actors[a.name]=a},removeActor:function(a){this._removeQueue.push(a)},registerInputEvents:function(a){this.eventActors[a.name]=a},addSound:function(a){var b=null;if(typeof a=="string"){b=new gamvas.Sound(this.resource.getSound(a))}else{b=a}this._afiles[b.url]=b;return b},update:function(b){var c=gamvas.timer.getGlobalTimeScale();for(var a in this._afiles){this._afiles[a].setRate(c)}},getActors:function(){var a=[];for(var b in this.actors){a.push(this.actors[b])}a.sort(gamvas._layerSort);return a},cleanUp:function(){if(this._removeQueue.length<1){return}var g=gamvas.physics.getWorld();var h=[];for(var b in this._removeQueue){var d=null;if(typeof this._removeQueue[b]=="string"){d=this._removeQueue[b]}else{d=this._removeQueue[b].name}h.push(d)}var e=[];var a=[];for(var b in this.actors){if(h.indexOf(b)!=-1){if(this.actors[b].usePhysics){g.DestroyBody(this.actors[b].body);this.actors[b].body=null}a.push(this.actors[b])}else{e[b]=this.actors[b]}}this.actors=e;var c=[];for(var b in this.eventActors){if(h.indexOf(b)!=-1){if((this.eventActors[b].usePhysics)&&(this.eventActors[b].body!==null)){g.DestroyBody(this.eventActors[b].body)}if(a.indexOf(this.eventActors[b])<0){delete (this.eventActors[b])}}else{c[b]=this.eventActors[b]}}this.eventActors=c;for(var b in a){delete a[b]}this._removeQueue=[]}});gamvas.state={_states:[],_currentState:null,_firstState:true,addState:function(b){gamvas.state._states[b.name]=b;if((gamvas._usePhys)&&(b.world===null)){var a=gamvas.state._currentState;gamvas.state._currentState=b.name;gamvas.physics.resetWorld(0,9.8,gamvas._doSleep);gamvas.state._currentState=a}if(gamvas.state._currentState===null){gamvas.state._currentState=b.name}},setState:function(b){if(gamvas.isSet(gamvas.state._states[b])){if((!gamvas.state._firstState)&&(gamvas.state._currentState!==null)){var c=gamvas.state.getCurrentState();if(c){c.leave()}}else{gamvas.state._firstState=false}var a=gamvas.state._states[b];gamvas.state._currentState=b;if(!a._isInitialized){a.init();a._isInitialized=true}a.enter()}},getState:function(a){if(typeof gamvas.state._states[a]!="undefined"){return gamvas.state._states[a]}return false},getCurrentState:function(){if(gamvas.state._currentState!==null){var a=gamvas.state._states[gamvas.state._currentState];return a}return false},update:function(r){var q=gamvas.state.getCurrentState();if(q){q.resource.cache=false;var o=q.resource.done();var h=null;if((gamvas._usePhys)&&(o)){h=gamvas.physics.getWorld();if(h!==null){h.Step(r,gamvas.physics.velocityIterations,gamvas.physics.positionIterations);var j=h.GetBodyList();var d=null;var m=null;var p=null;for(d=h.m_bodyList;d;d=d.m_next){p=d.GetUserData();if(p!==null){if(p.type=="actor"){p.data.updatePhysics()}}}}}var l=q.getActors();if(o){q.update(r)}if(q.autoClear){q.clearScreen()}if(o){for(var c=0;c<l.length;c++){if(l[c].isActive()){l[c].preDraw(r)}}q.preDraw(r)}var k=!q.disableCamera;if(k){q.camera.start()}if(o){for(var g=0;g<l.length;g++){if(l[g].isActive()){l[g].draw(r)}}q.draw(r)}if(k){q.camera.stop()}if(o){for(var e=0;e<l.length;e++){if(l[e].isActive()){l[e].postDraw(r)}}q.postDraw(r)}else{q.loading(r)}q.cleanUp()}},getCharCode:function(b){var a=0;if(typeof b.which=="undefined"){a=b.keyCode}else{a=b.which}return String.fromCharCode(a).toLowerCase()},onKeyDown:function(d){gamvas.key.setPressed(d.keyCode,true);var e=gamvas.state.getCurrentState();var a=gamvas.state.getCharCode(d);if(e){for(var c in e.eventActors){e.eventActors[c].onKeyDown(d.keyCode,a,d)}var b=e.onKeyDown(d.keyCode,a,d);if(!b){d.preventDefault()}return b}if(!gamvas.key.exitEvent()){d.preventDefault()}return gamvas.key.exitEvent()},onKeyUp:function(d){gamvas.key.setPressed(d.keyCode,false);var e=gamvas.state.getCurrentState();var a=gamvas.state.getCharCode(d);if(e){for(var c in e.eventActors){e.eventActors[c].onKeyUp(d.keyCode,a,d)}var b=e.onKeyUp(d.keyCode,a,d);if(!b){d.preventDefault()}return b}if(!gamvas.key.exitEvent()){d.preventDefault()}return gamvas.key.exitEvent()},onMouseDown:function(d){gamvas.mouse.setPressed(d.button,true);var h=gamvas.state.getCurrentState();var g=gamvas.getCanvasDimension();var e=gamvas.isFullScreen();if(h){var j=gamvas.mouse.getPosition();if(e){j.x=j.x/screen.width*g.w;j.y=j.y/screen.height*g.h}for(var c in h.eventActors){h.eventActors[c].onMouseDown(d.button,j.x,j.y,d)}var b=h.onMouseDown(d.button,j.x,j.y,d);d.returnValue=b;if(!b){d.preventDefault()}return b}var a=gamvas.mouse.exitEvent();d.returnValue=a;if(!a){d.preventDefault()}return a},onMouseUp:function(d){gamvas.mouse.setPressed(d.button,false);var h=gamvas.state.getCurrentState();var g=gamvas.getCanvasDimension();var e=gamvas.isFullScreen();if(h){var j=gamvas.mouse.getPosition();if(e){j.x=j.x/screen.width*g.w;j.y=j.y/screen.height*g.h}for(var c in h.eventActors){h.eventActors[c].onMouseUp(d.button,j.x,j.y,d)}var b=h.onMouseUp(d.button,j.x,j.y,d);d.returnValue=b;if(!b){d.preventDefault()}return b}var a=gamvas.mouse.exitEvent();d.returnValue=a;if(!a){d.preventDefault()}return a},onMouseMove:function(d){gamvas.mouse.setPosition(d.pageX,d.pageY);var h=gamvas.state.getCurrentState();var g=gamvas.getCanvasDimension();var e=gamvas.isFullScreen();if(h){var j=gamvas.mouse.getPosition();if(e){j.x=j.x/screen.width*g.w;j.y=j.y/screen.height*g.h}for(var c in h.eventActors){h.eventActors[c].onMouseMove(j.x,j.y,d)}var b=h.onMouseMove(j.x,j.y,d);d.returnValue=b;if(!b){d.preventDefault()}return b}var a=gamvas.mouse.exitEvent();d.returnValue=a;if(!a){d.preventDefault()}return a},_maxTouches:11,_touchMap:[false,false,false,false,false,false,false,false,false,false,false],_getTouchNum:function(b){for(var a=0;a<gamvas.state._maxTouches;a++){if(gamvas.state._touchMap[a]===b){return a}}for(var a=0;a<gamvas.state._maxTouches;a++){if(gamvas.state._touchMap[a]===false){gamvas.state._touchMap[a]=b;return a}}return 0},_removeTouch:function(b){for(var a=0;a<gamvas.state._maxTouches;a++){if(gamvas.state._touchMap[a]==b){gamvas.state._touchMap[a]=false;return}}},onTouchDown:function(j){gamvas.event.stopBubble(j);var k=gamvas.state.getCurrentState();var d=gamvas.getCanvasDimension();var g=gamvas.isFullScreen();if(k){var l=gamvas.getCanvasPosition();for(var b=0;b<j.changedTouches.length;b++){var a=gamvas.state._getTouchNum(j.changedTouches[b].identifier);var h=j.changedTouches[b].pageX-l.x;var e=j.changedTouches[b].pageY-l.y;if(g){h=h/screen.width*d.w;e=e/screen.height*d.h}for(var c in k.eventActors){k.eventActors[c].onTouchDown(a,h,e,j)}k.onTouchDown(a,h,e,j)}}return false},onTouchUp:function(k){gamvas.event.stopBubble(k);var l=gamvas.state.getCurrentState();var e=gamvas.getCanvasDimension();var h=gamvas.isFullScreen();if(l){var m=gamvas.getCanvasPosition();for(var b=0;b<k.changedTouches.length;b++){var d=k.changedTouches[b].identifier;var a=gamvas.state._getTouchNum(d);var j=k.changedTouches[b].pageX-m.x;var g=k.changedTouches[b].pageY-m.y;if(h){j=j/screen.width*e.w;g=g/screen.height*e.h}for(var c in l.eventActors){l.eventActors[c].onTouchUp(a,j,g,k)}l.onTouchUp(a,j,g,k);gamvas.state._removeTouch(d)}}return false},onTouchMove:function(j){gamvas.event.stopBubble(j);var k=gamvas.state.getCurrentState();var d=gamvas.getCanvasDimension();var g=gamvas.isFullScreen();if(k){var l=gamvas.getCanvasPosition();for(var b=0;b<j.changedTouches.length;b++){var a=gamvas.state._getTouchNum(j.changedTouches[b].identifier);var h=j.changedTouches[b].pageX-l.x;var e=j.changedTouches[b].pageY-l.y;if(g){h=h/screen.width*d.w;e=e/screen.height*d.h}for(var c in k.eventActors){k.eventActors[c].onTouchMove(a,h,e,j)}k.onTouchMove(a,h,e,j)}}return false},onOrientation:function(a){gamvas.event.stopBubble(a);var b=gamvas.state.getCurrentState();b.onOrientation(a.alpha,a.beta,a.gamma);return false},setup:function(){var c=gamvas.getCanvas();c.addEventListener("mousedown",gamvas.state.onMouseDown,false);c.addEventListener("mouseup",gamvas.state.onMouseUp,false);c.addEventListener("mousemove",gamvas.state.onMouseMove,false);if(gamvas.hasMultiTouch()){c.addEventListener("touchstart",gamvas.state.onTouchDown,false);c.addEventListener("touchmove",gamvas.state.onTouchMove,false);c.addEventListener("touchend",gamvas.state.onTouchUp,false);c.addEventListener("touchcancel",gamvas.state.onTouchUp,false)}if(gamvas.hasOrientation()){window.addEventListener("deviceorientation",gamvas.state.onOrientation,false)}if(gamvas.state._currentState!==null){var b=0;for(var a in gamvas.state._states){gamvas.state._states[a]._setup();if(b===0){gamvas.state.setState(a)}b++}}}};document.addEventListener("keydown",gamvas.state.onKeyDown,false);document.addEventListener("keyup",gamvas.state.onKeyUp,false);gamvas.Camera=function(a,d,b,c){this.position=new gamvas.Vector2D((a)?a:0,(d)?d:0);this.rotation=(b)?b:0;this.zoomFactor=(c)?c:1};gamvas.Camera.prototype.setPosition=function(a,b){this.position.x=a;this.position.y=b};gamvas.Camera.prototype.move=function(a,b){this.position.x+=a;this.position.y+=b};gamvas.Camera.prototype.setRotation=function(a){this.rotation=a};gamvas.Camera.prototype.rotate=function(a){this.rotation+=a};gamvas.Camera.prototype.setZoom=function(a){this.zoomFactor=a};gamvas.Camera.prototype.zoom=function(a){this.zoomFactor+=a};gamvas.Camera.prototype.start=function(){var e=gamvas.getCanvasDimension();var g=gamvas.getContext2D();var b=e.w/(this.zoomFactor*2);var a=e.h/(this.zoomFactor*2);g.save();g.scale(this.zoomFactor,this.zoomFactor);g.translate(b,a);g.rotate(this.rotation);g.translate(-this.position.x,-this.position.y)};gamvas.Camera.prototype.stop=function(){var a=gamvas.getContext2D();a.restore()};gamvas.Camera.prototype.toWorld=function(a,e){var c=gamvas.getCanvasDimension();var b=new gamvas.Vector2D((a-c.w/2)/this.zoomFactor,(e-c.h/2)/this.zoomFactor).rotate(-this.rotation);b.x+=this.position.x;b.y+=this.position.y;return b};gamvas.Camera.prototype.toScreen=function(a,e){var c=gamvas.getCanvasDimension();var b=new gamvas.Vector2D(a-this.position.x,e-this.position.y).rotate(this.rotation);b.x=b.x*this.zoomFactor+c.w/2;b.y=b.y*this.zoomFactor+c.h/2;return b};gamvas.screen={frameLimit:0.1,_pause:false,_redrawHandlers:[],_lastFrameTime:-1,_lastFrameLength:0,_lastFPSCheck:0,_lastFPS:0,_fpsCounter:0,redraw:function(){window.requestAnimationFrame(gamvas.screen.redraw);if(gamvas.screen._pause){return}var c=gamvas.timer.getMilliseconds();if(gamvas.screen._lastFPSCheck<c){gamvas.screen._lastFPS=gamvas.screen._fpsCounter+1;gamvas.screen._fpsCounter=0;gamvas.screen._lastFPSCheck=c+1000}else{gamvas.screen._fpsCounter++}var b=0;if(gamvas.screen._lastFrameTime>-1){var a=gamvas.screen._lastFrameTime;gamvas.screen._lastFrameTime=c/1000;gamvas.screen._lastFrameLength=gamvas.screen._lastFrameTime-a;if(gamvas.screen._lastFrameLength>gamvas.screen.frameLimit){gamvas.screen._lastFrameLength=gamvas.screen.frameLimit}}else{gamvas.screen._lastFrameTime=0}gamvas.state.update(gamvas.screen._lastFrameLength);for(var d in gamvas.screen._redrawHandlers){(gamvas.screen._redrawHandlers[d])(gamvas.screen._lastFrameLength)}},getLastFrameLength:function(){return gamvas.screen._lastFrameLength},getFPS:function(){return gamvas.screen._lastFPS},setRedrawHandler:function(a){gamvas.screen._redrawHandlers._default=a},unsetRedrawHandler:function(){delete gamvas.screen._redrawHandlers._default},addRedrawHandler:function(b,a){gamvas.screen._redrawHandlers[b]=a},removeRedrawHandler:function(a){delete gamvas.screen._redrawHandlers[a]},pause:function(){gamvas.screen._pause=true},resume:function(){var a=gamvas.timer.getMilliseconds();gamvas.screen._lastFrameTime=(a/1000)-gamvas.screen.frameLimit;gamvas.screen._lastFrameLength=gamvas.screen.frameLimit;gamvas.screen._pause=false}};window.onblur=gamvas.screen.pause;window.onfocus=gamvas.screen.resume;gamvas.Image=function(c,b,e,a,d){this.image=c;this.position=new gamvas.Vector2D((b)?b:0,(e)?e:0);this.center=new gamvas.Vector2D((a)?a:0,(d)?d:0);this.rotation=0;this.scaleFactor=1;this.scaleFactor2=1;this.cr=null;this.c=gamvas.getContext2D();this.setRotation=function(g){this.rotation=g};this.rotate=function(g){this.rotation+=g};this.setPosition=function(g,h){this.position.x=g;this.position.y=h};this.move=function(g,h){this.position.x+=g;this.position.y+=h};this.setScale=function(g){this.scaleFactor=g;this.scaleFactor2=g};this.scale=function(g){this.scaleFactor+=g;this.scaleFactor2+=g};this.setScaleXY=function(g,h){this.scaleFactor=g;this.scaleFactor2=h};this.setCenter=function(g,h){this.center.x=g;this.center.y=h};this.setFile=function(g){this.image=g};this.draw=function(){var g=this.getClipRect();if((g.x>=0)&&(g.x<this.image.width)&&(g.y>=0)&&(g.y<this.image.height)&&(g.x+g.width<=this.image.width)&&(g.y+g.height<=this.image.height)){this.c.save();this.c.translate(this.position.x,this.position.y);this.c.rotate(this.rotation);this.c.scale(this.scaleFactor,this.scaleFactor2);this.c.drawImage(this.image,g.x,g.y,g.width,g.height,-this.center.x+g.x,-this.center.y+g.y,g.width,g.height);this.c.restore()}else{console.log("not drawing because of clip rect: ");console.log(g)}};this.setClipRect=function(j,k,g,i){if(j instanceof gamvas.Rect){this.cr=j}else{this.cr=new gamvas.Rect(j,k,g,i)}};this.getClipRect=function(){if(this.cr===null){this.cr=new gamvas.Rect(0,0,this.image.width,this.image.height)}return this.cr}};gamvas.Animation=gamvas.Class.extend({create:function(c,e,a,b,g,d){this.name=c;this.sprite=(e)?e:null;this.width=(a)?a:0;this.height=(b)?b:0;this.numberOfFrames=(g)?g:0;this.currentFrame=0;this.currentFrameTime=0;this.fDur=(d)?1/d:0.1;this.c=gamvas.getContext2D();this.frameList=[];this.position=new gamvas.Vector2D();this.center=new gamvas.Vector2D();this.rotation=0;this.scaleFactor=1;this.scaleFactor2=1},setFile:function(d,a,b,e,c){this.sprite=d;this.width=(a)?a:this.sprite.width;this.height=(b)?b:this.sprite.height;this.numberOfFrames=(e)?e:1;this.currentFrame=0;this.currentFrameTime=0;this.setFPS((c)?c:1);this.needInit=false;if((typeof this.width=="undefined")||(this.width===0)){this.needInit=true}},setFPS:function(a){this.fDur=1/a},setRotation:function(a){this.rotation=a},rotate:function(a){this.rotation+=a},setPosition:function(a,b){this.position.x=a;this.position.y=b},move:function(a,b){this.position.x+=a;this.position.y+=b},setScale:function(a){this.scaleFactor=a;this.scaleFactor2=a},scale:function(a){this.scaleFactor+=a;this.scaleFactor2+=a},setScaleXY:function(a,b){this.scaleFactor=a;this.scaleFactor2=b},setCenter:function(a,b){this.center.x=a;this.center.y=b},draw:function(a){this.drawFixed(a,this.c,this.position.x,this.position.y,-this.center.x,-this.center.y,this.rotation)},drawFixed:function(g,j,b,i,e,a,d,h){if(this.needInit){if((typeof this.sprite.width=="undefined")||(this.sprite.width===0)){return}this.width=this.sprite.width;this.height=this.sprite.height;this.needInit=false}this.currentFrameTime+=g;if(this.currentFrameTime>this.fDur){while(this.currentFrameTime>this.fDur){this.currentFrameTime-=this.fDur}this.currentFrame++;if(this.currentFrame>=this.numberOfFrames){this.currentFrame=0}}this.drawFrame(j,this.currentFrame,b,i,e,a,d,h)},drawFrame:function(h,j,l,i,p,n,b,e){if(!gamvas.isSet(this.sprite)){return}if(this.frameList.length>0){j=this.frameList[j]}var m=this._frameX(j)*this.width;var k=this._frameY(j)*this.height;var o=this.rotation;var d=-this.center.x;var a=-this.center.y;var g=this.scaleFactor;if(gamvas.isSet(p)){d=p}if(gamvas.isSet(n)){a=n}if(gamvas.isSet(b)){o=b}if(gamvas.isSet(e)){g=e}h.save();h.translate(l,i);h.rotate(b);h.scale(g,g);h.drawImage(this.sprite,m,k,this.width,this.height,-d,-a,this.width,this.height);h.restore()},_frameX:function(b){if(this.height===0){return 0}var a=this.sprite.width/this.width;return b%a},_frameY:function(b){if(this.width===0){return 0}var a=this.sprite.width/this.width;return Math.floor(b/a)},setFrameList:function(a){this.frameList=a;this.numberOfFrames=a.length}});gamvas.physics={DYNAMIC:(typeof Box2D=="undefined")?null:Box2D.Dynamics.b2Body.b2_dynamicBody,STATIC:(typeof Box2D=="undefined")?null:Box2D.Dynamics.b2Body.b2_staticBody,KINEMATIC:(typeof Box2D=="undefined")?null:Box2D.Dynamics.b2Body.b2_kinematicBody,pixelsPerMeter:64,velocityIterations:10,positionIterations:8,debugAlpha:0.3,debugStrokeWidth:2,toScreen:function(a){return a*gamvas.physics.pixelsPerMeter},toWorld:function(a){return a/gamvas.physics.pixelsPerMeter},_debugDrawer:null,drawDebug:function(){if(this._debugDrawer===null){this._debugDrawer=new Box2D.Dynamics.b2DebugDraw();this._debugDrawer.SetSprite(gamvas.getContext2D());this._debugDrawer.SetDrawScale(gamvas.physics.pixelsPerMeter);this._debugDrawer.SetFillAlpha(gamvas.physics.debugAlpha);this._debugDrawer.SetLineThickness(gamvas.physics.debugStrokeWidth);this._debugDrawer.SetFlags(Box2D.Dynamics.b2DebugDraw.e_shapeBit|Box2D.Dynamics.b2DebugDraw.e_jointBit);this._debugDrawer.m_sprite.graphics.clear=function(){};gamvas.physics.getWorld().SetDebugDraw(this._debugDrawer)}var a=gamvas.getContext2D();a.save();this.getWorld().DrawDebugData();a.restore()},setGravity:function(a){var b=gamvas.physics.getWorld();if(gamvas.isSet(b)){b.SetGravity(new Box2D.Common.Math.b2Vec2(a.x,a.y))}},resetWorld:function(b,a,e,c){var h=((gamvas.isSet(e))&&(e))?true:e;var k=(gamvas.isSet(b))?b:0;var j=(gamvas.isSet(a))?a:9.8;if(gamvas.config.worldPerState){var g=gamvas.state.getCurrentState();g._doSleep=h;g._world=new Box2D.Dynamics.b2World(new Box2D.Common.Math.b2Vec2(k,j),h)}else{gamvas._doSleep=h;gamvas._world=new Box2D.Dynamics.b2World(new Box2D.Common.Math.b2Vec2(k,j),h)}this._debugDrawer=null;var d=(gamvas.isSet(c))?c:new gamvas.physics.ContactListener();var i=gamvas.physics.getWorld();i.SetContactListener(d)},getWorld:function(){if(gamvas.config.worldPerState){var a=gamvas.state.getCurrentState();return a._world}else{return gamvas._world}}};gamvas.physics.UserData=function(a,b){this.type=a;this.data=b};if((typeof Box2D!="undefined")&&(typeof Box2D.Dynamics.b2ContactListener!="undefined")){gamvas.physics.ContactListener=Box2D.Dynamics.b2ContactListener;gamvas.physics.ContactListener.prototype.BeginContact=function(d){var b=d.GetFixtureA().GetBody().GetUserData();var a=d.GetFixtureB().GetBody().GetUserData();if((b.type=="actor")&&(a.type=="actor")){b.data.onCollisionEnter(a.data,d);a.data.onCollisionEnter(b.data,d)}};gamvas.physics.ContactListener.prototype.EndContact=function(d){var b=d.GetFixtureA().GetBody().GetUserData();var a=d.GetFixtureB().GetBody().GetUserData();if((b.type=="actor")&&(a.type=="actor")){b.data.onCollisionLeave(a.data,d);a.data.onCollisionLeave(b.data,d)}};gamvas.physics.ContactListener.prototype.PreSolve=function(e,a){var d=e.GetFixtureA().GetBody().GetUserData();var b=e.GetFixtureB().GetBody().GetUserData();if((d.type=="actor")&&(b.type=="actor")){if((!d.data.doCollide(b.data,e,a))||(!b.data.doCollide(d.data,e,a))){e.SetEnabled(false)}}};gamvas.physics.ContactListener.prototype.PostSolve=function(h,b){var g=h.GetFixtureA().GetBody().GetUserData();var e=h.GetFixtureB().GetBody().GetUserData();if((g.type=="actor")&&(e.type=="actor")){var a=b.normalImpulses[0];var d=b.tangentImpulses[0];g.data.onCollision(e.data,a,d,h);e.data.onCollision(g.data,a,d,h)}}}gamvas.AStar={STRATEGY_AVOID_STEPS:0,STRATEGY_IGNORE_STEPS:1};gamvas.AStarInfo=function(d,c,a,b){this.node=d;this.sw=c;this.tw=a;this.pi=b};gamvas.AStarMap=gamvas.Class.extend({create:function(a){this.nodes=new Array();this.returnFirst=true;if(typeof a!="undefined"){this.returnFirst=a}},includeFirstNode:function(a){this.returnFirst=a},add:function(a){if(a instanceof gamvas.AStarNode){this.nodes.push(a)}},find:function(g,n,o,a){var u=[];var p=null;var b=null;if((g instanceof gamvas.AStarNode)&&(n instanceof gamvas.AStarNode)){p=g;b=n}else{p=this.getNearest(g,n);b=this.getNearest(o,a);if((!(p instanceof gamvas.AStarNode))||(!(b instanceof gamvas.AStarNode))){return[]}}var j=[new gamvas.AStarInfo(p,0,0,null)];var i=[];var h=[];var k=false;var r=null;while((!k)&&(j.length)){r=j.shift();if(r.node===b){k=true;continue}for(var s=0;s<r.node.connected.length;s++){var e=r.node.connected[s];var v=e.objectID();if((!i[v])&&(!h[v])){var m=r.node.g(e);if(m<0){continue}var t=r.node.h(e,b);var q=r.sw+m+t;var d=false;for(var l=0;l<j.length&&d===false;l++){if(j[l].sw+j[l].tw>q){j.splice(l,0,new gamvas.AStarInfo(e,r.sw+m,t,r));i[v]=true;d=true}}if(!d){j.push(new gamvas.AStarInfo(e,r.sw+m,t,r));i[v]=true}}}h[r.node.objectID()]=true}if(k){while(r.pi!==null){u.unshift(r.node);r=r.pi}if(this.returnFirst){u.unshift(r.node)}}return u},getNearest:function(a,j){var h=null;if(a instanceof gamvas.AStarNode){h=new gamvas.AStarNode(a.position.x,a.position.y)}else{h=new gamvas.AStarNode(a,j)}var b=-1;var e=Infinity;for(var c=0;c<this.nodes.length;c++){if(this.nodes[c].id!=h.id){var g=h.position.quickDistance(this.nodes[c].position);if(g<e){e=g;b=c}}}if(b>=0){return this.nodes[b]}return null}});gamvas.AStarNode=gamvas.Class.extend({create:function(a,c,b){this.connected=new Array();this.position=new gamvas.Vector2D(a,c);(b)?this.id=b:this.id=this.position.x+"_"+this.position.y},g:function(a){return 1},h:function(c,b){var a=this.position.difference(b.position);return a.length()},connect:function(b,a){this.connected.push(b);if((a)||(typeof a=="undefined")){b.connect(this,false)}}});gamvas.AStarGrid=gamvas.AStarMap.extend({create:function(o,d,e,k,g,c){this._super(k);if(typeof g=="undefined"){this.strategy=0}else{this.strategy=g}this.width=o;this.height=d;this.setDefault(c);if(typeof e!="undefined"){this.useDiagonal=e}else{this.useDiagonal=false}for(var l=0;l<d;l++){for(var m=0;m<o;m++){this.add(new gamvas.AStarGridNode(this.strategy,this.defaultValue,m,l))}}for(var j=0;j<d;j++){for(var a=0;a<o;a++){var i=null;var b=this.nodes[j*o+a];if(a>0){i=this.nodes[(j)*o+(a-1)];b.connect(i,false);if(this.useDiagonal){if(j>0){i=this.nodes[(j-1)*o+(a-1)];b.connect(i,false)}if(j<d-1){i=this.nodes[(j+1)*o+(a-1)];b.connect(i,false)}}}if(j>0){i=this.nodes[(j-1)*o+(a)];b.connect(i,false)}if(j<this.height-1){i=this.nodes[(j+1)*o+(a)];b.connect(i,false)}if(a<this.width-1){i=this.nodes[(j)*o+(a+1)];b.connect(i,false);if(this.useDiagonal){if(j>0){i=this.nodes[(j-1)*o+(a+1)];b.connect(i,false)}if(j<d-1){i=this.nodes[(j+1)*o+(a+1)];b.connect(i,false)}}}}}},setDefault:function(a){if(a){this.defaultValue=a}else{this.defaultValue=0}},setValue:function(a,c,b){if((a<this.width)&&(c<this.height)){this.nodes[c*this.width+a].setValue(b)}},getValue:function(a,b){if((a<this.width)&&(b<this.height)){return this.nodes[b*this.width+a].value}return -1},find:function(b,c,d,e){if((b instanceof gamvas.AStarNode)&&(c instanceof gamvas.AStarNode)){return this._super(b,c)}if((b<this.width)&&(c<this.height)&&(d<this.width)&&(e<this.width)){var g=this.nodes[c*this.width+b];var a=this.nodes[e*this.width+d];return this._super(g,a)}}});gamvas.AStarGridNode=gamvas.AStarNode.extend({create:function(c,b,a,e,d){this._super(a,e,d);this.strategy=c;this.value=b},setValue:function(a){this.value=a},g:function(a){if(this.value<0){return this.value}if(this.strategy==1){if(a.value<0){return a.value}return 0}if(a.value<0){return a.value}return Math.abs(this.value-a.value)}});gamvas.ActorState=gamvas.Class.extend({create:function(a){this._isInitialized=false;this.name=a;this.actor=null},init:function(){},enter:function(){},leave:function(){},preDraw:function(a){},draw:function(a){var b=this.actor.getCurrentAnimation();b.drawFixed(a,gamvas.getContext2D(),this.actor.position.x,this.actor.position.y,this.actor.center.x,this.actor.center.y,this.actor.rotation,this.actor.scaleFactor)},postDraw:function(a){},update:function(a){},onKeyDown:function(c,b,a){},onKeyUp:function(c,b,a){},onMouseDown:function(b,a,d,c){},onMouseUp:function(b,a,d,c){},onMouseMove:function(a,c,b){},onTouchDown:function(d,a,c,b){return gamvas.mouse.exitEvent()},onTouchUp:function(d,a,c,b){return gamvas.mouse.exitEvent()},onTouchMove:function(d,a,c,b){return gamvas.mouse.exitEvent()},onCollision:function(b,d,e,g){},onCollisionEnter:function(b,d){},onCollisionLeave:function(b,d){},doCollide:function(b,e,d){return true}});gamvas.Actor=gamvas.Class.extend({create:function(b,a,c){this.name=(b)?b:"unnamed_"+this.objectID();this.position=new gamvas.Vector2D((a)?a:0,(c)?c:0);this.center=new gamvas.Vector2D(0,0);this.animations=[];this.currentAnimation=null;this.rotation=0;this.scaleFactor=1;this.density=1;this.friction=0.5;this.restitution=0.3;this.type="";this.layer=0;this.usePhysics=false;this._isActive=true;this.body=null;this.bodyDef=null;this.fixture=null;this.fixtureDef=null;this.states=[];this.currentState=null;this.addState(new gamvas.ActorState("default"));this.currentState="default";this.addAnimation(new gamvas.Animation("default"));this.currentAnimation="default";this.init()},init:function(){},addState:function(b,a){this.states[b.name]=b;this.states[b.name].actor=this;if((gamvas.isSet(a))&&(a)){this.setState(b.name)}},addAnimation:function(a){this.animations[a.name]=a},createBody:function(b,a){this.bodyDef=new Box2D.Dynamics.b2BodyDef;this.bodyDef.type=b;this.fixtureDef=new Box2D.Dynamics.b2FixtureDef;this.fixtureDef.density=this.density;this.fixtureDef.friction=this.friction;this.fixtureDef.restitution=this.restitution;this.fixtureDef.shape=a;this.body=gamvas.physics.getWorld().CreateBody(this.bodyDef);this.body.SetUserData(new gamvas.physics.UserData("actor",this));this.fixture=this.body.CreateFixture(this.fixtureDef);this.usePhysics=true},bodyRect:function(c,i,h,b,g){if(!gamvas.isSet(g)){g=Box2D.Dynamics.b2Body.b2_dynamicBody}var a=h/2;var d=b/2;var e=new Box2D.Collision.Shapes.b2PolygonShape;e.SetAsBox(gamvas.physics.toWorld(a),gamvas.physics.toWorld(d));this.createBody(g,e);this.center.x=a;this.center.y=d;this.setPosition(c,i)},bodyCircle:function(b,e,a,d){if(!gamvas.isSet(d)){d=Box2D.Dynamics.b2Body.b2_dynamicBody}var c=new Box2D.Collision.Shapes.b2CircleShape(gamvas.physics.toWorld(a));this.createBody(d,c);this.center.x=a;this.center.y=a;this.setPosition(b,e)},bodyPolygon:function(h,g,e,b,a,d){if(!gamvas.isSet(d)){d=Box2D.Dynamics.b2Body.b2_dynamicBody}var k=new Box2D.Collision.Shapes.b2PolygonShape;var j=[];for(var c=0;c<e.length;c++){if((e[c].length>1)){j.push(new Box2D.Common.Math.b2Vec2(gamvas.physics.toWorld(e[c][0]-b),gamvas.physics.toWorld(e[c][1]-a)))}}k.SetAsArray(j,j.length);this.createBody(d,k);this.setCenter(b,a);this.setPosition(h,g)},updatePhysics:function(){var a=this.body.GetPosition();this.position.x=a.x*gamvas.physics.pixelsPerMeter;this.position.y=a.y*gamvas.physics.pixelsPerMeter;this.rotation=this.body.GetAngle()},resetForces:function(a,c,b){this.body.SetLinearVelocity(new Box2D.Common.Math.b2Vec2(0,0));this.body.SetAngularVelocity(0);if((typeof a!="undefined")&&(typeof c!="undefined")){this.setPosition(a,c);if(typeof b!="undefined"){this.setRotation(b)}}this.body.SetAwake(true)},setBullet:function(a){this.body.SetBullet(a)},setSensor:function(a){this.fixture.SetSensor(a)},setAwake:function(a){this.body.SetAwake(a)},setFixedRotation:function(a){this.body.SetFixedRotation(a)},setName:function(a){this.name=a},setRotation:function(a){if(this.usePhysics){this.body.SetAngle(a)}else{this.rotation=a}},rotate:function(a){if(this.usePhysics){this.body.SetAngle(this.body.GetAngle()+a)}else{this.rotation+=a}},setPosition:function(a,b){if(this.usePhysics){this.body.SetPosition(new Box2D.Common.Math.b2Vec2(a/gamvas.physics.pixelsPerMeter,b/gamvas.physics.pixelsPerMeter))}else{this.position.x=a;this.position.y=b}},move:function(a,c){if(this.usePhysics){var b=this.body.GetPosition();this.body.SetPosition(new Box2D.Common.Math.b2Vec2(b.x+(a/gamvas.physics.pixelsPerMeter),b.y+(c/gamvas.physics.pixelsPerMeter)))}else{this.position.x+=a;this.position.y+=c}},setScale:function(a){this.scaleFactor=a},scale:function(a){this.scaleFactor+=a},setLinearDamping:function(a){this.body.SetLinearDamping(a)},setAngularDamping:function(a){this.body.SetAngularDamping(a)},setCenter:function(a,b){this.center.x=a;this.center.y=b},getCurrentAnimation:function(){return this.animations[this.currentAnimation]},getCurrentState:function(){return this.states[this.currentState]},setFile:function(c,a,b,e,d){this.getCurrentAnimation().setFile(c,a,b,e,d)},preDraw:function(a){var b=this.getCurrentState();if(b){b.preDraw(a)}},draw:function(a){var b=this.getCurrentState();if(b){b.update(a);b.draw(a)}},postDraw:function(a){var b=this.getCurrentState();if(b){b.postDraw(a)}},isActive:function(){return this._isActive},setActive:function(a){this._isActive=a},setState:function(b){if(gamvas.isSet(this.states[b])){if(this.currentState!==null){var c=this.getCurrentState();if(c){c.leave()}}var a=this.states[b];if(!a._isInitialized){a.init();a._isInitialized=true}a.enter();this.currentState=b}},setAnimation:function(b){if(gamvas.isSet(this.animations[b])){this.currentAnimation=b}},onCollision:function(b,d,e,h){var g=this.getCurrentState();if(g){g.onCollision(b,d,e,h)}},onCollisionEnter:function(b,e){var d=this.getCurrentState();if(d){d.onCollisionEnter(b,e)}},onCollisionLeave:function(b,e){var d=this.getCurrentState();if(d){d.onCollisionLeave(b,e)}},doCollide:function(b,g,d){var e=this.getCurrentState();if(e){return e.doCollide(b,g,d)}return true},onKeyDown:function(c,b,a){var d=this.getCurrentState();if(d){return d.onKeyDown(c,b,a)}return false},onKeyUp:function(c,b,a){var d=this.getCurrentState();if(d){return d.onKeyUp(c,b,a)}return false},onMouseDown:function(b,a,e,c){var d=this.getCurrentState();if(d){return d.onMouseDown(b,a,e,c)}return false},onMouseUp:function(b,a,e,c){var d=this.getCurrentState();if(d){return d.onMouseUp(b,a,e,c)}return false},onMouseMove:function(a,d,b){var c=this.getCurrentState();if(c){return c.onMouseMove(a,d,b)}return false},onTouchDown:function(e,a,d,b){var c=this.getCurrentState();if(c){return c.onTouchDown(e,a,d,b)}return gamvas.mouse.exitEvent()},onTouchUp:function(e,a,d,b){var c=this.getCurrentState();if(c){return c.onTouchUp(e,a,d,b)}return gamvas.mouse.exitEvent()},onTouchMove:function(e,a,d,b){var c=this.getCurrentState();if(c){return c.onTouchMove(e,a,d,b)}return gamvas.mouse.exitEvent()},setFPS:function(a){this.getCurrentAnimation().setFPS(a)},setFrameList:function(a){this.getCurrentAnimation().setFrameList(a)},setGroupIndex:function(b){var a=null;for(f=this.body.GetFixtureList();f;f=f.m_next){a=f.GetFilterData();a.groupIndex=b;f.SetFilterData(a)}},setCategoryBits:function(a){var c=null;for(f=this.body.GetFixtureList();f;f=f.m_next){c=f.GetFilterData();c.categoryBits=a;f.SetFilterData(c)}},setMaskBits:function(a){var c=null;for(f=this.body.GetFixtureList();f;f=f.m_next){c=f.GetFilterData();c.maskBits=a;f.SetFilterData(c)}},getBox2DVectorFromValue:function(c,a){var b=null;if(a instanceof Box2D.Common.Math.b2Vec2){b=a}else{if(a instanceof gamvas.Vector2D){b=new Box2D.Common.Math.b2Vec2(a.x,a.y)}else{b=c.body.GetWorldCenter()}}return b},addRevoluteJoint:function(d,g,e){var a=new Box2D.Dynamics.Joints.b2RevoluteJointDef();var c=this.getBox2DVectorFromValue(d,g);a.Initialize(this.body,d.body,c);if(gamvas.isSet(e)){for(var b in e){switch(b){case"upperAngle":a.upperAngle=e[b];break;case"lowerAngle":a.lowerAngle=e[b];break;case"enableLimit":a.enableLimit=e[b];break;case"maxMotorTorque":a.maxMotorTorque=e[b];break;case"motorSpeed":a.motorSpeed=e[b];break;case"enableMotor":a.enableMotor=e[b];break;default:break}}}return new gamvas.physics.getWorld().CreateJoint(a)},addPrismaticJoint:function(e,j,b,h){var a=new Box2D.Dynamics.Joints.b2PrismaticJointDef();var d=this.getBox2DVectorFromValue(e,j);var g=this.getBox2DVectorFromValue(e,b);a.Initialize(this.body,e.body,d,g);if(gamvas.isSet(h)){for(var c in h){switch(c){case"upperTranslation":a.upperTranslation=h[c];break;case"lowerTranslation":a.lowerTranslation=h[c];break;case"enableLimit":a.enableLimit=h[c];break;case"maxMotorForce":a.maxMotorForce=h[c];break;case"motorSpeed":a.motorSpeed=h[c];break;case"enableMotor":a.enableMotor=h[c];break;default:break}}}return new gamvas.physics.getWorld().CreateJoint(a)}});gamvas.Particle=function(b,a){this.e=b;this.lt=a;this.anim=null;this.position=new gamvas.Vector2D();this.velocity=new gamvas.Vector2D();this.life=0;this.rotation=0;this.scale=1;this.rotVel=0;this.dmp=0;this.rotDmp=0;this.update=function(e,d,c){if(this.rotVel>0){this.rotVel-=this.rotDmp*e;if(this.rotVel<=0){this.rotDemp=0;this.rotVel=0}}else{if(this.rotVel<0){this.rotVel+=this.rotDmp*e;if(this.rotVel>=0){this.rotDemp=0;this.rotVel=0}}}this.rotation+=this.rotVel*e;if((this.dmp>0)&&(this.velocity.quickLength()>0)){this.velocity.x*=1-this.dmp*e;if(this.velocity.x===0){this.velocity.x=0;this.velocity.y=0}else{this.velocity.y*=1-this.dmp*e}}this.velocity.x+=this.e.gravity.x*e;this.velocity.y+=this.e.gravity.y*e;this.position.x+=this.velocity.x*e;this.position.y+=this.velocity.y*e;if(this.anim!==null){this.anim.setPosition(this.position.x,this.position.y)}};this.getLife=function(){return this.life/this.lt}};gamvas.ParticleEmitter=gamvas.Actor.extend({create:function(c,a,e,b,d){this._super(c,a,e);this._emit=0;this.limit=0;this.lifeTime=0;this.emitted=0;this.isAnim=(d)?d:false;this.animLifeTime=true;this.f=(b)?b:null;this.particles=[];this.partRate=10;this.partRateRange=0;this.rotRange=Math.PI*0.002;this.partAlign=false;this.partRot=0;this.partRotRange=0;this.partRotVel=0;this.partRotVelRange=0;this.partScale=1;this.partScaleRange=0;this.partSpeed=20;this.partSpeedRange=0;this.partLifeTime=5;this.partLifeTimeRange=0;this.partDamp=0;this.partDampRange=0;this.partRotDamp=0;this.partRotDampRange=0;this.positionRange=new gamvas.Vector2D();this.gravity=new gamvas.Vector2D();this.st=[[0,1],[1,1]];this.spstx=[[0,1],[1000,1]];this.spsty=[[0,1],[1000,1]];this.at=[[0,1],[1,1]]},setImage:function(a){this.isAnim=false;this.f=a},setAnimation:function(a){this.isAnim=true;this.f=a},setAnimationLifeTime:function(a){this.animLifeTime=a},setRotationRange:function(a){this.rotRange=a},setParticleRate:function(a){this.partRate=a},getParticleRate:function(){return this.partRate},setParticleRateRange:function(a){this.partRateRange=a},setParticleLimit:function(a){this.limit=a},alignParticleToPath:function(a){this.partAlign=a},setParticleRotation:function(a){this.partRot=a},setParticleRotationRange:function(a){this.partRotRange=a},setParticleRotationVelocity:function(a){this.partRotVel=a},setParticleRotationVelocityRange:function(a){this.partRotVelRange=a},setParticleScale:function(a){this.partScale=a},setParticleScaleRange:function(a){this.partScaleRange=a},setParticleSpeed:function(a){this.partSpeed=a},setParticleSpeedRange:function(a){this.partSpeedRange=a},setParticleLifeTime:function(a){this.partLifeTime=a},setParticleLifeTimeRange:function(a){this.partLifeTimeRange=a},setParticleVelocityDamping:function(a){this.partDamp=a},setParticleVelocityDampingRange:function(a){this.partDampRange=a},setParticleRotationDamping:function(a){this.partRotDamp=a},setParticleRotationDampingRange:function(a){this.partRotDampRange=a},setParticleStartPositionRange:function(a){this.positionRange=a},setGravity:function(a){this.gravity=a},setScaleTable:function(a){this.st=a},setAlphaTable:function(a){this.at=a},setSpeedScaleTable:function(a){this.spstx=[];this.spsty=[];for(var b in a){this.spstx.push([a[b][0],a[b][1]]);this.spsty.push([a[b][0],a[b][2]])}},draw:function(s){this.lifeTime+=s;if((this.limit===0)||(this.emitted<this.limit)){this._emit+=s*this.getRandomValue(this.partRate,this.partRateRange);if(this._emit>1){var j=Math.floor(this._emit);this._emit-=j;for(var g=0;g<j;g++){var u=new gamvas.Particle(this,this.getRandomValue(this.partLifeTime,this.partLifeTimeRange));if(this.isAnim){u.anim=new gamvas.Animation(this.name+this.emitted,this.f.sprite,this.f.width,this.f.height,this.f.numberOfFrames);u.anim.setCenter(this.f.center.x,this.f.center.y);u.anim.fDur=this.f.fDur}u.rotation=this.getRandomValue(this.partRot,this.partRotRange);u.rotVel=this.getRandomValue(this.partRotVel,this.partRotVelRange);u.dmp=this.getRandomValue(this.partDamp,this.partDampRange);u.scale=this.getRandomValue(this.partScale,this.partScaleRange);u.rotDmp=this.getRandomValue(this.partRotDamp,this.partRotDampRange);u.position.x=this.getRandomValue(this.position.x,this.positionRange.x);u.position.y=this.getRandomValue(this.position.y,this.positionRange.y);var a=new gamvas.Vector2D(0,this.getRandomValue(this.partSpeed,this.partSpeedRange));u.velocity=a.rotate(this.getRandomValue(this.rotation,this.rotRange));this.particles.push(u);if(this.limit>0){this.emitted++;if(this.emitted>=this.limit){break}}}}}var o=[];for(var h=0;h<this.particles.length;h++){var b=this.particles[h];b.life+=s;if(b.life<=b.lt){b.update(s);if(!this.isAnim){this.f.setPosition(b.position.x,b.position.y)}var n=this.getTableValue(this.st,b.getLife());if(this.partAlign){var d=b.velocity.length();var m=this.getTableValue(this.spstx,d);var k=this.getTableValue(this.spsty,d);if(this.isAnim){b.anim.setScaleXY(m*n,k*n);b.anim.setRotation(Math.atan2(b.velocity.y,b.velocity.x)+0.5*Math.PI)}else{this.f.setScaleXY(m*n,k*n);this.f.setRotation(Math.atan2(b.velocity.y,b.velocity.x)+0.5*Math.PI)}}else{if(this.isAnim){b.anim.setScale(b.scale*n);b.anim.setRotation(b.rotation)}else{this.f.setScale(b.scale*n);this.f.setRotation(b.rotation)}}this.f.c.globalAlpha=this.getTableValue(this.at,b.getLife());if(this.isAnim){if(this.animLifeTime){var c=b.lt-b.life;var q=b.anim.numberOfFrames*(1-(b.life/b.lt));b.anim.fDur=c/q;b.anim.draw(s)}else{b.anim.draw(s)}}else{this.f.draw(s)}o.push(b)}else{this.onParticleEnd(b.position,b.rotation,b.scale,b.velocity);delete b}}this.particles=o;this.f.c.globalAlpha=1},getRandomValue:function(b,a){return b+((Math.random()-0.5)*2)*a},getTableValue:function(c,j){var m=0;var g=0;var e=false;for(var d in c){if(c[d][0]<j){m=d}else{e=true;g=d;break}}if(c[c.length-1][0]<=j){return c[c.length-1][1]}if(!e){return 1}var k=j-c[m][0];var a=c[g][0]-c[m][0];var h=k/a;if(c[g][1]>c[m][1]){var b=c[g][1]-c[m][1];return c[m][1]+b*h}var l=c[m][1]-c[g][1];return c[g][1]+l*(1-h)},reset:function(a){this._emit=0;this.lifeTime=0;this.emitted=0;if((gamvas.isSet(a))&&(a)){this.particles=[]}},onParticleEnd:function(d,a,c,b){}});